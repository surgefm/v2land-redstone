{"version":3,"sources":["../api/oauth/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import type { Express, Request, Response } from 'express';\nimport randomString from 'crypto-random-string';\nimport { AuthorizationClient, AuthorizationCode, Client } from '@Models';\nimport { RedstoneRequest } from '@Types';\n\nfunction escapeHtml(str: string): string {\n  return String(str)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#039;');\n}\n\nexport function mountOAuth(app: Express) {\n  const serverUrl = process.env.API_URL || 'https://api.langchao.org';\n  const frontendUrl = process.env.FRONTEND_URL || 'https://langchao.org';\n\n  // OAuth2 Authorization Server Metadata (RFC 8414)\n  app.get('/.well-known/oauth-authorization-server', (_req, res) => {\n    res.json({\n      issuer: serverUrl,\n      authorization_endpoint: `${serverUrl}/oauth/authorize`,\n      token_endpoint: `${serverUrl}/oauth2/token`,\n      registration_endpoint: `${serverUrl}/oauth/register`,\n      response_types_supported: ['code'],\n      grant_types_supported: ['authorization_code', 'refresh_token', 'client_credentials'],\n      token_endpoint_auth_methods_supported: ['none', 'client_secret_post'],\n      code_challenge_methods_supported: ['S256'],\n    });\n  });\n\n  // OAuth2 Protected Resource Metadata (RFC 9728)\n  app.get('/.well-known/oauth-protected-resource', (_req, res) => {\n    res.json({\n      resource: `${serverUrl}/mcp`,\n      authorization_servers: [serverUrl],\n      bearer_methods_supported: ['header'],\n    });\n  });\n\n  // Dynamic Client Registration (RFC 7591)\n  app.post('/oauth/register', async (req: Request, res: Response) => {\n    const { redirect_uris, client_name, token_endpoint_auth_method, grant_types, response_types } = req.body;\n\n    if (!redirect_uris || !Array.isArray(redirect_uris) || redirect_uris.length === 0) {\n      return res.status(400).json({\n        error: 'invalid_client_metadata',\n        error_description: 'redirect_uris is required',\n      });\n    }\n\n    const authClient = await AuthorizationClient.create({\n      name: client_name || 'MCP Client',\n      description: 'Dynamically registered MCP client',\n      redirectURI: redirect_uris[0],\n      allowAuthorizationByCredentials: false,\n    });\n\n    return res.status(201).json({\n      client_id: String(authClient.id),\n      client_name: authClient.name,\n      redirect_uris,\n      token_endpoint_auth_method: token_endpoint_auth_method || 'none',\n      grant_types: grant_types || ['authorization_code'],\n      response_types: response_types || ['code'],\n    });\n  });\n\n  // Authorization endpoint - GET\n  // If user has an active session → show consent page\n  // If not logged in → redirect to frontend login page\n  app.get('/oauth/authorize', async (req: Request, res: Response) => {\n    const { response_type, client_id } = req.query;\n\n    if (response_type !== 'code') {\n      return res.status(400).send('Unsupported response_type');\n    }\n\n    const authClient = await AuthorizationClient.findByPk(client_id as string);\n    if (!authClient) {\n      return res.status(400).send('Invalid client_id');\n    }\n\n    const clientId = (req as RedstoneRequest).session?.clientId;\n\n    // Not logged in → redirect to frontend login, then back here\n    if (!clientId) {\n      const currentUrl = `${serverUrl}/oauth/authorize?${new URLSearchParams(req.query as Record<string, string>).toString()}`;\n      const loginUrl = `${frontendUrl}/login?redirect=${encodeURIComponent(currentUrl)}`;\n      return res.redirect(loginUrl);\n    }\n\n    // Logged in → show consent page\n    const client = await Client.findByPk(clientId);\n    const username = client ? (client as any).username || `User #${clientId}` : `User #${clientId}`;\n    const clientName = escapeHtml(authClient.name || 'MCP Client');\n\n    const hiddenFields = ['response_type', 'client_id', 'redirect_uri', 'code_challenge', 'code_challenge_method', 'state', 'scope', 'resource']\n      .map(key => {\n        const val = req.query[key] as string || '';\n        return `<input type=\"hidden\" name=\"${key}\" value=\"${escapeHtml(val)}\">`;\n      })\n      .join('\\n      ');\n\n    res.send(`<!DOCTYPE html>\n<html lang=\"zh\"><head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>授权 - 浪潮</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }\n    .card { background: white; border-radius: 12px; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n    h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }\n    .desc { color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }\n    .user { background: #f0f5ff; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1.5rem; font-size: 0.9rem; }\n    .actions { display: flex; gap: 0.75rem; }\n    .btn { flex: 1; padding: 0.7rem; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }\n    .btn-primary { background: #1890ff; color: white; }\n    .btn-primary:hover { background: #40a9ff; }\n    .btn-deny { background: #f0f0f0; color: #666; }\n    .btn-deny:hover { background: #e0e0e0; }\n  </style>\n</head><body>\n  <div class=\"card\">\n    <h1>授权访问</h1>\n    <p class=\"desc\"><strong>${clientName}</strong> 请求访问你的浪潮编辑室账户。</p>\n    <div class=\"user\">已登录为 <strong>${escapeHtml(username)}</strong></div>\n    <form method=\"POST\" action=\"/oauth/authorize\">\n      ${hiddenFields}\n      <div class=\"actions\">\n        <button type=\"submit\" name=\"action\" value=\"approve\" class=\"btn btn-primary\">授权</button>\n        <button type=\"submit\" name=\"action\" value=\"deny\" class=\"btn btn-deny\">拒绝</button>\n      </div>\n    </form>\n  </div>\n</body></html>`);\n  });\n\n  // Authorization endpoint - POST processes consent\n  app.post('/oauth/authorize', async (req: Request, res: Response) => {\n    const {\n      client_id, redirect_uri, code_challenge, code_challenge_method, state, action,\n    } = req.body;\n\n    // If user denied\n    if (action === 'deny') {\n      if (redirect_uri) {\n        const params = new URLSearchParams({ error: 'access_denied', error_description: 'User denied the request' });\n        if (state) params.set('state', state);\n        return res.redirect(`${redirect_uri}?${params.toString()}`);\n      }\n      return res.status(403).send('Access denied');\n    }\n\n    // Require session\n    const clientId = (req as RedstoneRequest).session?.clientId;\n    if (!clientId) {\n      return res.status(401).send('Not authenticated');\n    }\n\n    // Validate client\n    const authClient = await AuthorizationClient.findByPk(client_id);\n    if (!authClient) {\n      return res.status(400).send('Invalid client_id');\n    }\n\n    // Generate authorization code\n    const code = randomString({ length: 64, type: 'url-safe' });\n    await AuthorizationCode.create({\n      code,\n      expire: new Date(Date.now() + 10 * 60 * 1000), // 10 minutes\n      url: redirect_uri || '',\n      owner: clientId,\n      authorizationClientId: authClient.id,\n      codeChallenge: code_challenge || null,\n      codeChallengeMethod: code_challenge_method || null,\n    });\n\n    // Redirect back to client with code\n    const params = new URLSearchParams({ code });\n    if (state) params.set('state', state);\n    return res.redirect(`${redirect_uri}?${params.toString()}`);\n  });\n}\n"],"sourceRoot":"../../../src"}