{"version":3,"sources":["../api/services/AgentService/lock.ts"],"names":[],"mappings":"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","file":"lock.js","sourcesContent":["import * as RedisService from '../RedisService';\n\nconst LOCK_TTL = 300; // 5 minutes\n\nfunction lockKey(eventId: number) {\n  return `agent-lock:${eventId}`;\n}\n\nfunction inboxKey(eventId: number) {\n  return `agent-inbox:${eventId}`;\n}\n\nfunction stopKey(eventId: number) {\n  return `agent-stop:${eventId}`;\n}\n\nexport async function acquireLock(eventId: number): Promise<boolean> {\n  if (!RedisService.redis) return false;\n  const key = RedisService.redis.options?.keyPrefix\n    ? lockKey(eventId)\n    : lockKey(eventId);\n  const result = await RedisService.redis.set(\n    key,\n    JSON.stringify({ startedAt: new Date().toISOString(), status: 'running' }),\n    'EX',\n    LOCK_TTL,\n    'NX',\n  );\n  return result === 'OK';\n}\n\nexport async function releaseLock(eventId: number): Promise<void> {\n  if (!RedisService.redis) return;\n  await Promise.all([\n    RedisService.redis.del(lockKey(eventId)),\n    RedisService.redis.del(inboxKey(eventId)),\n    RedisService.redis.del(stopKey(eventId)),\n  ]);\n}\n\nexport async function refreshLock(eventId: number): Promise<void> {\n  if (!RedisService.redis) return;\n  await RedisService.redis.expire(lockKey(eventId), LOCK_TTL);\n}\n\nexport async function isLocked(eventId: number): Promise<boolean> {\n  if (!RedisService.redis) return false;\n  const val = await RedisService.redis.get(lockKey(eventId));\n  return val !== null;\n}\n\nexport async function pushToInbox(eventId: number, message: string): Promise<void> {\n  if (!RedisService.redis) return;\n  await RedisService.redis.rpush(inboxKey(eventId), message);\n  await RedisService.redis.expire(inboxKey(eventId), LOCK_TTL);\n}\n\nexport async function drainInbox(eventId: number): Promise<string[]> {\n  if (!RedisService.redis) return [];\n  const messages: string[] = [];\n  while (true) {\n    const msg = await RedisService.redis.lpop(inboxKey(eventId));\n    if (!msg) break;\n    messages.push(msg);\n  }\n  return messages;\n}\n\nexport async function requestStop(eventId: number): Promise<void> {\n  if (!RedisService.redis) return;\n  await RedisService.redis.set(stopKey(eventId), '1', 'EX', LOCK_TTL);\n}\n\nexport async function shouldStop(eventId: number): Promise<boolean> {\n  if (!RedisService.redis) return false;\n  const val = await RedisService.redis.get(stopKey(eventId));\n  return val !== null;\n}\n"],"sourceRoot":"../../../../src"}