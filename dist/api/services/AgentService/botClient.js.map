{"version":3,"sources":["../api/services/AgentService/botClient.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,qCAAiC;AACjC,gEAAkD;AAClD,8EAAgE;AAEhE,IAAI,iBAAiB,GAAkB,IAAI,CAAC;AAE5C,SAAsB,oBAAoB;;QACxC,IAAI,iBAAiB,EAAE;YACrB,MAAM,MAAM,GAAG,MAAM,gBAAM,CAAC,QAAQ,CAAC,iBAAiB,CAAC,CAAC;YACxD,IAAI,MAAM,EAAE;gBACV,SAAS,CAAC,MAAM,CAAC,CAAC;gBAClB,OAAO,MAAM,CAAC;aACf;YACD,iBAAiB,GAAG,IAAI,CAAC;SAC1B;QAED,IAAI,MAAM,GAAG,MAAM,gBAAM,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,EAAE,QAAQ,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;QAElE,IAAI,CAAC,MAAM,EAAE;YACX,MAAM,GAAG,MAAM,aAAa,CAAC,YAAY,CAAC;gBACxC,QAAQ,EAAE,KAAK;gBACf,QAAQ,EAAE,KAAK;gBACf,KAAK,EAAE,cAAc;gBACrB,aAAa,EAAE,IAAI;aACpB,CAAC,CAAC;YAEH,MAAM,oBAAoB,CAAC,qBAAqB,CAAC,MAAM,CAAC,EAAE,EAAE,MAAM,CAAC,EAAE,CAAC,CAAC;YACvE,MAAM,oBAAoB,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE,EAAE,oBAAoB,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;SAC7F;QAED,SAAS,CAAC,MAAM,CAAC,CAAC;QAClB,iBAAiB,GAAG,MAAM,CAAC,EAAE,CAAC;QAC9B,OAAO,MAAM,CAAC;IAChB,CAAC;CAAA;AA3BD,oDA2BC;AAED,SAAS,SAAS,CAAC,MAAc;IAC/B,IAAI,MAAM,CAAC,IAAI,KAAK,OAAO,IAAI,MAAM,CAAC,IAAI,KAAK,SAAS,EAAE;QACxD,MAAM,IAAI,KAAK,CACb,oCAAoC,MAAM,CAAC,IAAI,KAAK;YACpD,kDAAkD,CACnD,CAAC;KACH;AACH,CAAC;AAED,SAAgB,cAAc;IAC5B,OAAO,iBAAiB,CAAC;AAC3B,CAAC;AAFD,wCAEC","file":"botClient.js","sourcesContent":["import { Client } from '@Models';\nimport * as ClientService from '../ClientService';\nimport * as AccessControlService from '../AccessControlService';\n\nlet cachedBotClientId: number | null = null;\n\nexport async function getOrCreateBotClient(): Promise<Client> {\n  if (cachedBotClientId) {\n    const client = await Client.findByPk(cachedBotClientId);\n    if (client) {\n      guardRole(client);\n      return client;\n    }\n    cachedBotClientId = null;\n  }\n\n  let client = await Client.findOne({ where: { username: 'Bot' } });\n\n  if (!client) {\n    client = await ClientService.createClient({\n      username: 'Bot',\n      nickname: 'Bot',\n      email: 'bot@surge.fm',\n      emailVerified: true,\n    });\n\n    await AccessControlService.allowClientToEditRole(client.id, client.id);\n    await AccessControlService.addUserRoles(client.id, AccessControlService.roles.contributors);\n  }\n\n  guardRole(client);\n  cachedBotClientId = client.id;\n  return client;\n}\n\nfunction guardRole(client: Client) {\n  if (client.role === 'admin' || client.role === 'manager') {\n    throw new Error(\n      `Bot account has disallowed role '${client.role}'. ` +\n      `The @Bot account must never be admin or manager.`\n    );\n  }\n}\n\nexport function getBotClientId(): number | null {\n  return cachedBotClientId;\n}\n"],"sourceRoot":"../../../../src"}