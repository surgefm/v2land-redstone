{"version":3,"sources":["../api/services/AgentService/run.ts"],"names":[],"mappings":"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","file":"run.js","sourcesContent":["import OpenAI from 'openai';\nimport type { ChatCompletionMessageParam, ChatCompletionChunk } from 'openai/resources/chat/completions';\nimport type { Stream } from 'openai/streaming';\nimport { randomUUID } from 'crypto';\nimport * as EventService from '@Services/EventService';\nimport * as ChatService from '@Services/ChatService';\nimport { AgentStatus } from '@Models';\nimport { SYSTEM_PROMPT } from './prompt';\nimport { TOOL_DEFINITIONS, executeTool, ToolContext } from './tools';\nimport { getOrCreateBotClient } from './botClient';\nimport { ensureBotAccess } from './ensureBotAccess';\nimport * as AgentLock from './lock';\n\nconst MAX_ITERATIONS = 50;\nconst THINKING_FLUSH_INTERVAL_MS = 100;\nconst THINKING_FLUSH_SIZE = 200;\n\nasync function emitAgentStatus(eventId: number, status: string | null, runId: string, botClientId: number) {\n  const timestamp = new Date().toISOString();\n  if (status !== null) {\n    try {\n      await AgentStatus.create({\n        id: randomUUID(),\n        runId,\n        eventId,\n        type: 'status',\n        status,\n        authorId: botClientId,\n      } as any);\n    } catch (err: any) {\n      console.error('[AgentService] Failed to persist agent status:', err.message);\n    }\n  }\n  const socket = await EventService.getNewsroomSocket(eventId);\n  socket.emit('agent status', { eventId, status, runId, timestamp });\n}\n\nfunction getToolStatusMessage(toolName: string, args: Record<string, any>): string | null {\n  switch (toolName) {\n    case 'search_news':\n      return `正在搜索：${args.query || ''}`;\n    case 'get_current_stacks':\n      return '正在获取当前时间线状态...';\n    case 'create_stack':\n      return `正在创建进展：${args.title || ''}`;\n    case 'add_news_to_event':\n      return `正在添加新闻：${args.title || ''}`;\n    case 'add_news_to_stack':\n      return `正在将新闻归入进展...`;\n    case 'update_stack':\n      return `正在更新进展：${args.title || `ID ${args.stackId}`}`;\n    case 'reorder_stacks':\n      return '正在调整进展排序...';\n    case 'send_chat_message':\n      return null; // Don't emit status for chat messages themselves\n    case 'ask_user_question':\n      return `正在向用户提问：${args.question || ''}`;\n    default:\n      return null;\n  }\n}\n\nexport async function run(eventId: number, userMessage?: string): Promise<void> {\n  const botClient = await getOrCreateBotClient();\n  const botClientId = botClient.id;\n  const runId = randomUUID();\n\n  // Try to acquire lock\n  const acquired = await AgentLock.acquireLock(eventId);\n  if (!acquired) {\n    // Agent already running — push message to inbox for mid-run correction\n    if (userMessage) {\n      await AgentLock.pushToInbox(eventId, userMessage);\n    }\n    return;\n  }\n\n  try {\n    // Check bot has edit access to this event\n    const hasAccess = await ensureBotAccess(eventId);\n    if (!hasAccess) return;\n\n    // Load chat history for context\n    const recentMessages = await ChatService.loadMessages('newsroom', eventId);\n    const chatHistory = recentMessages\n      .reverse() // loadMessages returns DESC, we want chronological\n      .map((m: any) => {\n        const plain = m.get ? m.get({ plain: true }) : m;\n        return `[${plain.authorId === botClientId ? 'Bot' : `User ${plain.authorId}`}]: ${plain.text}`;\n      })\n      .join('\\n');\n\n    // Load current event state\n    const event = await EventService.findEvent(eventId, { plain: true, getNewsroomContent: true });\n    if (!event) {\n      await ChatService.sendMessage('newsroom', botClientId, '未找到该事件。', eventId);\n      return;\n    }\n\n    // Build initial context for the LLM\n    const eventContext = buildEventContext(event);\n\n    const messages: ChatCompletionMessageParam[] = [\n      { role: 'system', content: SYSTEM_PROMPT },\n      {\n        role: 'user',\n        content: [\n          `## 当前时间`,\n          `现在是 ${new Date().toISOString()}（UTC时间）`,\n          `## 当前事件信息`,\n          eventContext,\n          `## 近期编辑室聊天记录`,\n          chatHistory || '（无聊天记录）',\n          `## 用户指示`,\n          userMessage || '请更新时间线，搜索最新的相关新闻。',\n        ].join('\\n\\n'),\n      },\n    ];\n\n    const openai = new OpenAI({\n      baseURL: 'https://openrouter.ai/api/v1',\n      apiKey: process.env.OPEN_ROUTER_API_KEY,\n    });\n\n    const ctx: ToolContext = { eventId, clientId: botClientId, botClientId, runId };\n\n    // Agentic tool-calling loop\n    for (let i = 0; i < MAX_ITERATIONS; i++) {\n      // Check stop flag\n      if (await AgentLock.shouldStop(eventId)) {\n        await ChatService.sendMessage('newsroom', botClientId, 'Bot 已被手动停止。', eventId);\n        break;\n      }\n\n      let assistantMessage: {\n        role: 'assistant';\n        content: string | null;\n        tool_calls?: { id: string; type: 'function'; function: { name: string; arguments: string } }[];\n      };\n\n      try {\n        const abortController = new AbortController();\n        const stream = await openai.chat.completions.create({\n          model: 'deepseek/deepseek-v3.2',\n          messages,\n          tools: TOOL_DEFINITIONS,\n          tool_choice: 'auto',\n          reasoning: { effort: 'low' },\n          stream: true,\n        } as any, { signal: abortController.signal }) as unknown as Stream<ChatCompletionChunk>;\n\n        // Process stream — accumulate content, reasoning, and tool_calls\n        let accumulatedContent = '';\n        let accumulatedReasoning = '';\n        const toolCallsMap = new Map<number, { id: string; name: string; arguments: string }>();\n\n        // Buffer for thinking chunks to reduce socket emissions\n        let thinkingBuffer = '';\n        let lastThinkingFlush = Date.now();\n        let tokenCount = 0;\n\n        const newsroomSocket = await EventService.getNewsroomSocket(eventId);\n\n        for await (const chunk of stream) {\n          const delta = chunk.choices?.[0]?.delta;\n          if (!delta) continue;\n\n          tokenCount++;\n\n          // Periodically check if agent should stop\n          if (tokenCount % 50 === 0 && await AgentLock.shouldStop(eventId)) {\n            abortController.abort();\n            break;\n          }\n\n          // Handle reasoning/thinking — OpenRouter returns reasoning in `reasoning` or `reasoning_content`\n          const reasoningChunk = (delta as any).reasoning_content || (delta as any).reasoning;\n          if (reasoningChunk) {\n            accumulatedReasoning += reasoningChunk;\n            thinkingBuffer += reasoningChunk;\n\n            const now = Date.now();\n            if (now - lastThinkingFlush >= THINKING_FLUSH_INTERVAL_MS || thinkingBuffer.length > THINKING_FLUSH_SIZE) {\n              newsroomSocket.emit('agent thinking', {\n                eventId,\n                runId,\n                chunk: thinkingBuffer,\n                done: false,\n              });\n              thinkingBuffer = '';\n              lastThinkingFlush = now;\n            }\n          }\n\n          // Handle content\n          if (delta.content) {\n            accumulatedContent += delta.content;\n          }\n\n          // Handle tool_calls\n          if (delta.tool_calls) {\n            for (const tc of delta.tool_calls) {\n              if (!toolCallsMap.has(tc.index)) {\n                toolCallsMap.set(tc.index, { id: tc.id || '', name: '', arguments: '' });\n              }\n              const existing = toolCallsMap.get(tc.index)!;\n              if (tc.id) existing.id = tc.id;\n              if (tc.function?.name) existing.name += tc.function.name;\n              if (tc.function?.arguments) existing.arguments += tc.function.arguments;\n            }\n          }\n        }\n\n        // Flush remaining thinking buffer\n        if (thinkingBuffer.length > 0) {\n          newsroomSocket.emit('agent thinking', {\n            eventId,\n            runId,\n            chunk: thinkingBuffer,\n            done: true,\n          });\n        } else if (accumulatedReasoning.length > 0) {\n          newsroomSocket.emit('agent thinking', {\n            eventId,\n            runId,\n            chunk: '',\n            done: true,\n          });\n        }\n\n        // Persist accumulated reasoning as a single record per LLM call\n        if (accumulatedReasoning.length > 0) {\n          try {\n            await AgentStatus.create({\n              id: randomUUID(),\n              runId,\n              eventId,\n              type: 'thinking',\n              status: accumulatedReasoning,\n              authorId: botClientId,\n            } as any);\n          } catch (err: any) {\n            console.error('[AgentService] Failed to persist agent thinking:', err.message);\n          }\n        }\n\n        // Reconstruct the assistant message in the same shape as non-streaming\n        const toolCalls = toolCallsMap.size > 0\n          ? Array.from(toolCallsMap.values()).map(tc => ({\n              id: tc.id,\n              type: 'function' as const,\n              function: { name: tc.name, arguments: tc.arguments },\n            }))\n          : undefined;\n\n        assistantMessage = {\n          role: 'assistant',\n          content: accumulatedContent || null,\n          tool_calls: toolCalls,\n        };\n      } catch (apiError: any) {\n        if (apiError.name === 'AbortError') {\n          // Agent was stopped mid-stream\n          await ChatService.sendMessage('newsroom', botClientId, 'Bot 已被手动停止。', eventId);\n          break;\n        }\n        console.error('[AgentService] API call failed:', apiError.message, apiError.status, JSON.stringify(apiError.error ?? {}));\n        await ChatService.sendMessage('newsroom', botClientId, `AI 服务调用失败：${apiError.message}`, eventId);\n        break;\n      }\n\n      messages.push(assistantMessage as ChatCompletionMessageParam);\n\n      // Emit agent's reasoning text as ephemeral status\n      // (skip if the message also has tool_calls — that content is internal reasoning)\n      if (assistantMessage.content && (!assistantMessage.tool_calls || assistantMessage.tool_calls.length === 0)) {\n        await emitAgentStatus(eventId, assistantMessage.content, runId, botClientId);\n      }\n\n      // If no tool calls, the agent is done\n      if (!assistantMessage.tool_calls || assistantMessage.tool_calls.length === 0) {\n        break;\n      }\n\n      // Execute tool calls\n      let askedQuestion = false;\n      for (const toolCall of assistantMessage.tool_calls) {\n        const fn = toolCall.function;\n        let args: Record<string, any>;\n        try {\n          args = JSON.parse(fn.arguments);\n        } catch {\n          args = {};\n        }\n\n        // Emit status before tool execution\n        const statusMsg = getToolStatusMessage(fn.name, args);\n        if (statusMsg) {\n          await emitAgentStatus(eventId, statusMsg, runId, botClientId);\n        }\n\n        const result = await executeTool(fn.name, args, ctx);\n\n        if (fn.name === 'ask_user_question') {\n          askedQuestion = true;\n        }\n\n        // Emit result summary for search\n        if (fn.name === 'search_news') {\n          try {\n            const parsed = JSON.parse(result);\n            await emitAgentStatus(eventId, `找到 ${parsed.count || 0} 篇相关文章`, runId, botClientId);\n          } catch {}\n        }\n\n        messages.push({\n          role: 'tool',\n          tool_call_id: toolCall.id,\n          content: result,\n        });\n      }\n\n      // Check inbox for mid-run corrections (skip if ask_user_question\n      // already drained the inbox to get the user's answer)\n      if (!askedQuestion) {\n        const inboxMessages = await AgentLock.drainInbox(eventId);\n        if (inboxMessages.length > 0) {\n          const correction = inboxMessages.join('\\n\\n');\n          messages.push({\n            role: 'user',\n            content: `[编辑室新消息] ${correction}`,\n          });\n        }\n      }\n    }\n\n    // Ensure a persistent chat message is always sent when the agent finishes,\n    // so the user is never left wondering what happened.\n    // Only use content from the last assistant message that has NO tool_calls\n    // (messages with tool_calls are intermediate reasoning, not user-facing).\n    const lastFinalAssistantMsg = [...messages].reverse().find(\n      m => m.role === 'assistant' && !('tool_calls' in m && (m as any).tool_calls?.length > 0),\n    );\n    let finalText = lastFinalAssistantMsg && 'content' in lastFinalAssistantMsg\n      ? (lastFinalAssistantMsg.content as string)\n      : null;\n\n    // Strip any raw function-call XML markup that some models may leak into content\n    if (finalText) {\n      finalText = finalText.replace(/<function_call>[\\s\\S]*?<\\/function_call>/g, '').trim();\n      finalText = finalText.replace(/<\\/?function_call>/g, '').trim();\n    }\n\n    if (finalText) {\n      await ChatService.sendMessage('newsroom', botClientId, finalText, eventId);\n    } else {\n      await ChatService.sendMessage('newsroom', botClientId, '已完成本次更新。', eventId);\n    }\n\n    // Signal agent completion\n    await emitAgentStatus(eventId, null, runId, botClientId);\n  } catch (err: any) {\n    console.error(`[AgentService] Error running agent for event ${eventId}:`, err);\n    try {\n      const botClient = await getOrCreateBotClient();\n      await ChatService.sendMessage(\n        'newsroom',\n        botClient.id,\n        `运行出错：${err.message || '未知错误'}`,\n        eventId,\n      );\n      await emitAgentStatus(eventId, null, runId, botClient.id);\n    } catch {\n      // Ignore chat send errors during error handling\n    }\n  } finally {\n    await AgentLock.releaseLock(eventId);\n  }\n}\n\nfunction buildEventContext(event: any): string {\n  const lines: string[] = [\n    `事件名称: ${event.name}`,\n    `事件描述: ${event.description || '（无描述）'}`,\n  ];\n\n  if (event.tags && event.tags.length > 0) {\n    lines.push(`标签: ${event.tags.map((t: any) => t.name).join(', ')}`);\n  }\n\n  if (event.stacks && event.stacks.length > 0) {\n    lines.push(`\\n### 现有进展 (${event.stacks.length}个):`);\n    for (const stack of event.stacks) {\n      lines.push(`- [ID:${stack.id}] ${stack.title} (${stack.status}, order:${stack.order}, time:${stack.time || '未知'})`);\n      if (stack.description) {\n        lines.push(`  描述: ${stack.description}`);\n      }\n      if (stack.news && stack.news.length > 0) {\n        for (const news of stack.news) {\n          lines.push(`  - [NewsID:${news.id}] ${news.title} (${news.source}, ${news.time || '未知'}) ${news.url}`);\n        }\n      }\n    }\n  } else {\n    lines.push('\\n时间线当前没有进展条目。');\n  }\n\n  if (event.offshelfNews && event.offshelfNews.length > 0) {\n    lines.push(`\\n### 待整理新闻 (${event.offshelfNews.length}条):`);\n    for (const news of event.offshelfNews) {\n      lines.push(`- [NewsID:${news.id}] ${news.title} (${news.source}, ${news.time || '未知'}) ${news.url}`);\n    }\n  }\n\n  return lines.join('\\n');\n}\n"],"sourceRoot":"../../../../src"}