{"version":3,"sources":["../api/modes/ThirtyDaysSinceLatestStackMode.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,qCAAgC;AAChC,mCAAiE;AACjE,uCAAmC;AACnC,sEAAqC;AACrC,yCAA+B;AAE/B,MAAa,8BAA+B,SAAQ,yBAAgB;IAApE;;QACE,SAAI,GAAG,wBAAwB,CAAC;QAChC,aAAQ,GAAG,UAAU,CAAC;QACtB,mBAAc,GAAG,IAAI,CAAC;IAsCxB,CAAC;IApCO,GAAG,CAAC,EAAE,KAAK,EAAE,KAAK,EAAyB;;YAC/C,MAAM,WAAW,GAAG,KAAK,KAAI,MAAM,eAAK,CAAC,OAAO,CAAC;gBAC/C,KAAK,EAAE;oBACL,OAAO,EAAE,KAAK,CAAC,EAAE;oBACjB,MAAM,EAAE,UAAU;oBAClB,KAAK,EAAE,EAAE,CAAC,cAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE;iBACvB;gBACD,KAAK,EAAE,CAAC,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;aAC3B,CAAC,CAAA,CAAC;YAEH,IAAI,CAAC,WAAW,EAAE;gBAChB,OAAO,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC;aAC7B;iBAAM;gBACL,MAAM,IAAI,GAAG,IAAA,yBAAM,EAAC,IAAI,IAAI,EAAE,CAAC,CAAC,EAAE,CAAC,eAAe,CAAC,CAAC;gBACpD,IAAI,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;gBACd,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;gBACf,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;gBACf,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,EAAE,CAAC,CAAC;gBAE5B,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;gBACxB,OAAO,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;aAChE;QACH,CAAC;KAAA;IAEK,QAAQ;;YACZ,OAAO,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC;QAC9B,CAAC;KAAA;IAEK,WAAW,CAAC,EAAE,KAAK,EAAyB;;YAChD,OAAO;gBACL,OAAO,EAAE,GAAG,KAAK,CAAC,IAAI,WAAW;gBACjC,OAAO,EAAE,GAAG,KAAK,CAAC,IAAI,wBAAwB;gBAC9C,MAAM,EAAE,UAAU;gBAClB,GAAG,EAAE,GAAG,kBAAO,CAAC,IAAI,IAAI,KAAK,CAAC,EAAE,EAAE;aACnC,CAAC;QACJ,CAAC;KAAA;CACF;AAzCD,wEAyCC;AAED,kBAAe,IAAI,8BAA8B,EAAE,CAAC","file":"ThirtyDaysSinceLatestStackMode.js","sourcesContent":["import { Stack } from '@Models';\nimport { NotificationMode, NotificationModeInput } from '@Types';\nimport { globals } from '@Configs';\nimport moment from 'moment-timezone';\nimport { Op } from 'sequelize';\n\nexport class ThirtyDaysSinceLatestStackMode extends NotificationMode {\n  name = '30DaysSinceLatestStack';\n  nickname = '三十天未更新进展';\n  keepLatestOnly = true;\n\n  async new({ event, stack }: NotificationModeInput) {\n    const latestStack = stack || await Stack.findOne({\n      where: {\n        eventId: event.id,\n        status: 'admitted',\n        order: { [Op.gte]: 0 },\n      },\n      order: [['order', 'DESC']],\n    });\n\n    if (!latestStack) {\n      return new Date('1/1/3000');\n    } else {\n      const date = moment(new Date()).tz('Asia/Shanghai');\n      date.hour(20);\n      date.minute(0);\n      date.second(0);\n      date.date(date.date() + 30);\n\n      const d = date.toDate();\n      return d.getTime() - Date.now() < 0 ? new Date('1/1/3000') : d;\n    }\n  }\n\n  async notified() {\n    return new Date('1/1/3000');\n  }\n\n  async getTemplate({ event }: NotificationModeInput) {\n    return {\n      subject: `${event.name} 已有七天没有消息`,\n      message: `${event.name} 已有七天没有消息，快去看看有什么新的进展。`,\n      button: '点击按钮查看事件',\n      url: `${globals.site}/${event.id}`,\n    };\n  }\n}\n\nexport default new ThirtyDaysSinceLatestStackMode();\n"],"sourceRoot":"../../../src"}