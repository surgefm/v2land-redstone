{"version":3,"sources":["../api/modes/SevenDaysSinceLatestNewsMode.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,qCAA+B;AAC/B,mCAAiE;AACjE,uCAAmC;AACnC,sEAAqC;AAErC,MAAa,4BAA6B,SAAQ,yBAAgB;IAAlE;;QACE,SAAI,GAAG,sBAAsB,CAAC;QAC9B,aAAQ,GAAG,SAAS,CAAC;QACrB,aAAQ,GAAG,KAAK,CAAC;QACjB,mBAAc,GAAG,IAAI,CAAC;IAsCxB,CAAC;IApCO,GAAG,CAAC,EAAE,KAAK,EAAE,IAAI,EAAyB;;YAC9C,MAAM,UAAU,GAAG,IAAI,KAAI,MAAM,cAAI,CAAC,OAAO,CAAC;gBAC5C,KAAK,EAAE,EAAE,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,KAAK,CAAC,EAAE,EAAE;gBAChD,KAAK,EAAE,CAAC,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;aAC1B,CAAC,CAAA,CAAC;YAEH,IAAI,CAAC,UAAU,EAAE;gBACf,OAAO,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC;aAC7B;iBAAM;gBACL,MAAM,IAAI,GAAG,IAAA,yBAAM,EAAC,IAAI,IAAI,EAAE,CAAC,CAAC,EAAE,CAAC,eAAe,CAAC,CAAC;gBACpD,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;gBACb,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;gBACf,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC;gBACf,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC,CAAC;gBAE3B,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;gBACxB,OAAO,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;aAChE;QACH,CAAC;KAAA;IAEK,MAAM,CAAC,EAAE,KAAK,EAAE,IAAI,EAAyB;;YACjD,OAAO,IAAI,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;QACnC,CAAC;KAAA;IAEK,QAAQ;;YACZ,OAAO,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC;QAC9B,CAAC;KAAA;IAEK,WAAW,CAAC,EAAE,KAAK,EAAyB;;YAChD,OAAO;gBACL,OAAO,EAAE,GAAG,KAAK,CAAC,IAAI,WAAW;gBACjC,OAAO,EAAE,GAAG,KAAK,CAAC,IAAI,wBAAwB;gBAC9C,MAAM,EAAE,UAAU;gBAClB,GAAG,EAAE,GAAG,kBAAO,CAAC,IAAI,IAAI,KAAK,CAAC,EAAE,EAAE;aACnC,CAAC;QACJ,CAAC;KAAA;CACF;AA1CD,oEA0CC;AAED,kBAAe,IAAI,4BAA4B,EAAE,CAAC","file":"SevenDaysSinceLatestNewsMode.js","sourcesContent":["import { News } from '@Models';\nimport { NotificationMode, NotificationModeInput } from '@Types';\nimport { globals } from '@Configs';\nimport moment from 'moment-timezone';\n\nexport class SevenDaysSinceLatestNewsMode extends NotificationMode {\n  name = '7DaysSinceLatestNews';\n  nickname = '七天未更新新闻';\n  needNews = false;\n  keepLatestOnly = true;\n\n  async new({ event, news }: NotificationModeInput) {\n    const latestNews = news || await News.findOne({\n      where: { status: 'admitted', eventId: event.id },\n      order: [['time', 'DESC']],\n    });\n\n    if (!latestNews) {\n      return new Date('1/1/3000');\n    } else {\n      const date = moment(new Date()).tz('Asia/Shanghai');\n      date.hour(8);\n      date.minute(0);\n      date.second(0);\n      date.date(date.date() + 7);\n\n      const d = date.toDate();\n      return d.getTime() - Date.now() < 0 ? new Date('1/1/3000') : d;\n    }\n  }\n\n  async update({ event, news }: NotificationModeInput) {\n    return this.new({ event, news });\n  }\n\n  async notified() {\n    return new Date('1/1/3000');\n  }\n\n  async getTemplate({ event }: NotificationModeInput) {\n    return {\n      subject: `${event.name} 已有七天没有消息`,\n      message: `${event.name} 已有七天没有消息，快去看看有什么新的进展。`,\n      button: '点击按钮查看事件',\n      url: `${globals.site}/${event.id}`,\n    };\n  }\n}\n\nexport default new SevenDaysSinceLatestNewsMode();\n"],"sourceRoot":"../../../src"}