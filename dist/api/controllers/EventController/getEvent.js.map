{"version":3,"sources":["../api/controllers/EventController/getEvent.ts"],"names":[],"mappings":";;;;;;;;;;;AACA,qCAAgC;AAChC,yCAAyG;AAEzG,SAAe,QAAQ,CAAC,GAAoB,EAAE,GAAqB;;QACjE,MAAM,OAAO,GAAG,MAAM,wBAAY,CAAC,UAAU,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QAC1D,IAAI,CAAC,OAAO,EAAE;YACZ,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBAC1B,OAAO,EAAE,QAAQ;aAClB,CAAC,CAAC;SACJ;QAED,MAAM,CAAC,GAAG,MAAM,eAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;QAExC,MAAM,UAAU,GAAG,GAAG,CAAC,KAAK,CAAC,MAAM,KAAK,GAAG,CAAC;QAC5C,MAAM,QAAQ,GAAG,CAAC,KAAe,EAAE,EAAE;YACnC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,eAAe;gBACxB,KAAK;aACN,CAAC,CAAC;QACL,CAAC,CAAC;QAEF,MAAM,KAAK,GAAG,MAAM,gCAAoB,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAClE,MAAM,SAAS,GAAG,MAAM,uBAAW,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QACxD,MAAM,iBAAiB,GAAG,MAAM,wBAAY,CAAC,IAAI,CAAC,wBAAY,CAAC,uBAAuB,CAAC,OAAO,CAAC,CAAC,CAAC;QACjG,MAAM,SAAS,GAAG,MAAM,wBAAY,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC;QAE3D,IAAI,YAAY,GAAG,KAAK,CAAC;QACzB,IAAI,UAAU,EAAE;YACd,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ;gBAAE,YAAY,GAAG,IAAI,CAAC;iBAC1C;gBACH,MAAM,UAAU,GAAG,CAAC,CAAC,MAAM,KAAK,UAAU;qBACxC,MAAM,gCAAoB,CAAC,oBAAoB,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAA,CAAC;gBACjF,IAAI,CAAC,UAAU;oBAAE,YAAY,GAAG,IAAI,CAAC;aACtC;SACF;QAED,MAAM,MAAM,GAAG,MAAM,yBAAa,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;QAC5D,MAAM,UAAU,GAAG,MAAM,CAAC,CAAC,iCACtB,MAAM,CAAC,IAAI,KACd,KAAK;YACL,SAAS;YACT,iBAAiB,EACjB,eAAe,EAAE,CAAC,CAAC,eAAe,EAClC,SAAS,IACT,CAAC,CAAC,IAAI,CAAC;QAET,IAAI,MAAM,IAAI,CAAC,UAAU,IAAI,CAAC,UAAU,IAAI,YAAY,CAAC,EAAE;YACzD,MAAM,CAAC,IAAI,CAAC,KAAK,GAAG,KAAK,CAAC;YAC1B,IAAI,YAAY;gBAAE,OAAO,QAAQ,CAAC,UAAU,CAAC,CAAC;YAC9C,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;SACzC;QAED,IAAI,YAAY;YAAE,OAAO,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;QAE9D,4DAA4D;QAC5D,MAAM,KAAK,GAAG,MAAM,wBAAY,CAAC,SAAS,CAAC,OAAO,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,kBAAkB,EAAE,IAAI,EAAE,CAAC,CAAC;QAC/F,KAAK,CAAC,YAAY,GAAG,MAAM,wBAAY,CAAC,eAAe,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;QACrE,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC;QACpB,KAAK,CAAC,SAAS,GAAG,SAAS,CAAC;QAC5B,KAAK,CAAC,iBAAiB,GAAG,iBAAiB,CAAC;QAC5C,KAAK,CAAC,SAAS,GAAG,SAAS,CAAC;QAC5B,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IAC9B,CAAC;CAAA;AAED,kBAAe,QAAQ,CAAC","file":"getEvent.js","sourcesContent":["import { RedstoneRequest, RedstoneResponse, EventObj } from '@Types';\nimport { Event } from '@Models';\nimport { EventService, CommitService, AccessControlService, StarService, RedisService } from '@Services';\n\nasync function getEvent(req: RedstoneRequest, res: RedstoneResponse) {\n  const eventId = await EventService.getEventId(req.params);\n  if (!eventId) {\n    return res.status(404).json({\n      message: '未找到该事件',\n    });\n  }\n\n  const e = await Event.findByPk(eventId);\n\n  const showLatest = req.query.latest === '1';\n  const noAccess = (event: EventObj) => {\n    res.status(401).json({\n      message: '你无权查看事件最新编辑情况',\n      event,\n    });\n  };\n\n  const roles = await AccessControlService.getEventClients(eventId);\n  const starCount = await StarService.countStars(eventId);\n  const subscriptionCount = await RedisService.hlen(RedisService.getSubscriptionCacheKey(eventId));\n  const curations = await EventService.getCurations(eventId);\n\n  let deniedAccess = false;\n  if (showLatest) {\n    if (!req.session.clientId) deniedAccess = true;\n    else {\n      const haveAccess = e.status === 'admitted' ||\n        await AccessControlService.isAllowedToViewEvent(req.session.clientId, eventId);\n      if (!haveAccess) deniedAccess = true;\n    }\n  }\n\n  const commit = await CommitService.getLatestCommit(eventId);\n  const commitData = commit ? {\n    ...commit.data,\n    roles,\n    starCount,\n    subscriptionCount,\n    needContributor: e.needContributor,\n    curations,\n  } : null;\n\n  if (commit && !showLatest || (showLatest && deniedAccess)) {\n    commit.data.roles = roles;\n    if (deniedAccess) return noAccess(commitData);\n    return res.status(200).json(commitData);\n  }\n\n  if (deniedAccess) return noAccess(commit ? commitData : null);\n\n  // If there is no commit or client wants the latest version.\n  const event = await EventService.findEvent(eventId, { plain: true, getNewsroomContent: true });\n  event.contribution = await EventService.getContribution(event, true);\n  event.roles = roles;\n  event.starCount = starCount;\n  event.subscriptionCount = subscriptionCount;\n  event.curations = curations;\n  res.status(200).json(event);\n}\n\nexport default getEvent;\n"],"sourceRoot":"../../../../src"}