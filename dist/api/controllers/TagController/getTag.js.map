{"version":3,"sources":["../api/controllers/TagController/getTag.ts"],"names":[],"mappings":"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","file":"getTag.js","sourcesContent":["import { Tag, Event, EventTag, News, Client, Sequelize, TagCuration } from '@Models';\nimport { RedstoneRequest, RedstoneResponse } from '@Types';\nimport { ClientService, TagService, EventService } from '@Services';\n\nasync function getTag(req: RedstoneRequest, res: RedstoneResponse) {\n  const tag = await Tag.findByPk(req.params.tagId, {\n    include: [{\n      model: Client,\n      as: 'curators',\n      through: { attributes: [] },\n      required: false,\n      attributes: ClientService.sanitizedFields,\n    }],\n  });\n\n  let tagVisible = !tag || tag.status !== 'hidden';\n  if (!tagVisible && req.currentClient) {\n    if (req.currentClient.isEditor) {\n      tagVisible = true;\n    }\n  }\n\n  if (!tag || !tagVisible) {\n    return res.status(404).json({\n      message: '无法找到该标签',\n    });\n  }\n\n  const allChildTags = await TagService.getAllChildTags({ tag });\n  const ids = [tag.id, ...allChildTags.map(t => t.id)];\n\n  const tagObj = tag.get({ plain: true }) as any;\n\n  const eventTags = await EventTag.findAll({\n    where: {\n      tagId: {\n        [Sequelize.Op.in]: ids,\n      },\n    },\n  });\n\n  const eventIds = Array.from(new Set(eventTags.map(t => t.eventId)));\n\n  const events = await Promise.all(eventIds.map(async id => {\n    const event = await Event.findOne({\n      where: {\n        id,\n        status: 'admitted',\n      },\n      include: [{\n        model: News,\n        as: 'latestAdmittedNews',\n        required: false,\n      }],\n    });\n    if (!event) return;\n    const eventObj = event.get({ plain: true }) as any;\n    eventObj.curations = await EventService.getCurations(event.id);\n    return eventObj;\n  }));\n\n  tagObj.events = events.filter(e => e).sort((a, b) => {\n    const isACertified = a.curations.find((c: TagCuration) => c.state === 'certified');\n    const isBCertified = b.curations.find((c: TagCuration) => c.state === 'certified');\n    const isAWarned = a.curations.find((c: TagCuration) => c.state === 'warning');\n    const isBWarned = b.curations.find((c: TagCuration) => c.state === 'warning');\n    if (isAWarned && !isBWarned) return 1;\n    if (!isAWarned && isBWarned) return -1;\n    if (isACertified && !isBCertified) return -1;\n    if (!isACertified && isBCertified) return 1;\n    return a.updatedAt > b.updatedAt ? -1 : 1;\n  });\n\n  tagObj.parents = await Promise.all(\n    (tag.hierarchyPath || [])\n      .filter(t => t !== tag.id)\n      .map(t => Tag.findByPk(t))\n  );\n  tagObj.children = await Tag.findAll({\n    where: {\n      parentId: tag.id,\n    },\n  });\n  return res.status(200).json({ tag: tagObj });\n}\n\nexport default getTag;\n"],"sourceRoot":"../../../../src"}