{"version":3,"sources":["../api/controllers/OAuth2Controller/token.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,mCAAoC;AACpC,+CAAiC;AAEjC,qCAA2F;AAC3F,yCAA0C;AAE1C,SAAe,KAAK,CAAC,GAAoB,EAAE,GAAqB;;QAC9D,MAAM,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC,UAAU,CAAC;QAEtC,IAAI,SAAS,KAAK,oBAAoB,EAAE;YACtC,OAAO,uBAAuB,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;SAC1C;aAAM,IAAI,SAAS,KAAK,oBAAoB,EAAE;YAC7C,OAAO,uBAAuB,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;SAC1C;aAAM,IAAI,SAAS,KAAK,eAAe,EAAE;YACxC,OAAO,kBAAkB,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;SACrC;QAED,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,wBAAwB,EAAE,CAAC,CAAC;IACnE,CAAC;CAAA;AAED,SAAe,uBAAuB,CAAC,GAAoB,EAAE,GAAqB;;QAChF,MAAM,EAAE,IAAI,EAAE,YAAY,EAAE,SAAS,EAAE,aAAa,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;QAElE,IAAI,CAAC,IAAI,EAAE;YACT,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,iBAAiB,EAAE,iBAAiB,EAAE,kBAAkB,EAAE,CAAC,CAAC;SAClG;QAED,MAAM,QAAQ,GAAG,MAAM,2BAAiB,CAAC,OAAO,CAAC,EAAE,KAAK,EAAE,EAAE,IAAI,EAAE,EAAE,CAAC,CAAC;QACtE,IAAI,CAAC,QAAQ,IAAI,IAAI,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,GAAG,IAAI,IAAI,EAAE,EAAE;YACvD,IAAI,QAAQ;gBAAE,MAAM,QAAQ,CAAC,OAAO,EAAE,CAAC;YACvC,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,0CAA0C,EAAE,CAAC,CAAC;SACxH;QAED,qBAAqB;QACrB,IAAI,MAAM,CAAC,QAAQ,CAAC,qBAAqB,CAAC,KAAK,MAAM,CAAC,SAAS,CAAC,EAAE;YAChE,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,oBAAoB,EAAE,CAAC,CAAC;SAClG;QAED,wBAAwB;QACxB,IAAI,QAAQ,CAAC,GAAG,KAAK,CAAC,YAAY,IAAI,EAAE,CAAC,EAAE;YACzC,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,uBAAuB,EAAE,CAAC,CAAC;SACrG;QAED,gBAAgB;QAChB,IAAI,QAAQ,CAAC,aAAa,EAAE;YAC1B,IAAI,CAAC,aAAa,EAAE;gBAClB,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,2BAA2B,EAAE,CAAC,CAAC;aACzG;YACD,MAAM,iBAAiB,GAAG,IAAA,mBAAU,EAAC,QAAQ,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;YACzF,IAAI,iBAAiB,KAAK,QAAQ,CAAC,aAAa,EAAE;gBAChD,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,0BAA0B,EAAE,CAAC,CAAC;aACxG;SACF;QAED,sDAAsD;QACtD,MAAM,WAAW,GAAG,MAAM,yBAAa,CAAC,iBAAiB,CACvD,QAAQ,CAAC,KAAK,EACd,QAAQ,CAAC,qBAAqB,EAC9B,IAAI,CACL,CAAC;QAEF,qCAAqC;QACrC,MAAM,QAAQ,CAAC,OAAO,EAAE,CAAC;QAEzB,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC,GAAG,IAAI,CAAC,CAAC;QAE3F,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,iBACzB,YAAY,EAAE,WAAW,CAAC,KAAK,EAC/B,UAAU,EAAE,QAAQ,EACpB,UAAU,EAAE,SAAS,IAClB,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC,CAAC,EAAE,aAAa,EAAE,WAAW,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,EAChF,CAAC;IACL,CAAC;CAAA;AAED,SAAe,uBAAuB,CAAC,GAAoB,EAAE,GAAqB;;QAChF,MAAM,QAAQ,GAAG,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC;QACpC,MAAM,YAAY,GAAG,GAAG,CAAC,IAAI,CAAC,aAAa,CAAC;QAE5C,IAAI,CAAC,QAAQ,IAAI,CAAC,YAAY,EAAE;YAC9B,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,iBAAiB,EAAE,iBAAiB,EAAE,0CAA0C,EAAE,CAAC,CAAC;SAC1H;QAED,MAAM,mBAAmB,GAAG,MAAM,6BAAmB,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QACzE,IAAI,CAAC,mBAAmB,IAAI,CAAC,mBAAmB,CAAC,MAAM,IAAI,CAAC,mBAAmB,CAAC,KAAK,EAAE;YACrF,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,gBAAgB,EAAE,CAAC,CAAC;SAC1D;QAED,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,YAAY,EAAE,mBAAmB,CAAC,MAAM,CAAC,CAAC;QAChF,IAAI,CAAC,QAAQ,EAAE;YACb,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,gBAAgB,EAAE,CAAC,CAAC;SAC1D;QAED,MAAM,WAAW,GAAG,MAAM,yBAAa,CAAC,iBAAiB,CACvD,mBAAmB,CAAC,KAAK,EACzB,mBAAmB,CAAC,EAAE,EACtB,KAAK,CACN,CAAC;QAEF,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC,GAAG,IAAI,CAAC,CAAC;QAE3F,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;YAC1B,YAAY,EAAE,WAAW,CAAC,KAAK;YAC/B,UAAU,EAAE,QAAQ;YACpB,UAAU,EAAE,SAAS;SACtB,CAAC,CAAC;IACL,CAAC;CAAA;AAED,SAAe,kBAAkB,CAAC,GAAoB,EAAE,GAAqB;;QAC3E,MAAM,EAAE,aAAa,EAAE,SAAS,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;QAE9C,IAAI,CAAC,aAAa,EAAE;YAClB,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,iBAAiB,EAAE,iBAAiB,EAAE,2BAA2B,EAAE,CAAC,CAAC;SAC3G;QAED,MAAM,aAAa,GAAG,MAAM,kCAAwB,CAAC,OAAO,CAAC;YAC3D,KAAK,EAAE,EAAE,YAAY,EAAE,aAAa,EAAE,MAAM,EAAE,QAAQ,EAAE;SACzD,CAAC,CAAC;QAEH,IAAI,CAAC,aAAa,EAAE;YAClB,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,uBAAuB,EAAE,CAAC,CAAC;SACrG;QAED,iCAAiC;QACjC,IAAI,SAAS,IAAI,MAAM,CAAC,aAAa,CAAC,qBAAqB,CAAC,KAAK,MAAM,CAAC,SAAS,CAAC,EAAE;YAClF,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,KAAK,EAAE,eAAe,EAAE,iBAAiB,EAAE,oBAAoB,EAAE,CAAC,CAAC;SAClG;QAED,yBAAyB;QACzB,MAAM,WAAW,GAAG,MAAM,yBAAa,CAAC,iBAAiB,CACvD,aAAa,CAAC,KAAK,EACnB,aAAa,CAAC,qBAAqB,EACnC,IAAI,CACL,CAAC;QAEF,MAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC,GAAG,IAAI,CAAC,CAAC;QAE3F,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,iBACzB,YAAY,EAAE,WAAW,CAAC,KAAK,EAC/B,UAAU,EAAE,QAAQ,EACpB,UAAU,EAAE,SAAS,IAClB,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC,CAAC,EAAE,aAAa,EAAE,WAAW,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,EAChF,CAAC;IACL,CAAC;CAAA;AAED,kBAAe,KAAK,CAAC","file":"token.js","sourcesContent":["import { createHash } from 'crypto';\nimport * as bcrypt from 'bcrypt';\nimport { RedstoneRequest, RedstoneResponse } from '@Types';\nimport { AuthorizationClient, AuthorizationCode, AuthorizationAccessToken } from '@Models';\nimport { OAuth2Service } from '@Services';\n\nasync function token(req: RedstoneRequest, res: RedstoneResponse) {\n  const grantType = req.body.grant_type;\n\n  if (grantType === 'authorization_code') {\n    return handleAuthorizationCode(req, res);\n  } else if (grantType === 'client_credentials') {\n    return handleClientCredentials(req, res);\n  } else if (grantType === 'refresh_token') {\n    return handleRefreshToken(req, res);\n  }\n\n  return res.status(400).json({ error: 'unsupported_grant_type' });\n}\n\nasync function handleAuthorizationCode(req: RedstoneRequest, res: RedstoneResponse) {\n  const { code, redirect_uri, client_id, code_verifier } = req.body;\n\n  if (!code) {\n    return res.status(400).json({ error: 'invalid_request', error_description: 'code is required' });\n  }\n\n  const authCode = await AuthorizationCode.findOne({ where: { code } });\n  if (!authCode || new Date(authCode.expire) < new Date()) {\n    if (authCode) await authCode.destroy();\n    return res.status(400).json({ error: 'invalid_grant', error_description: 'Authorization code is invalid or expired' });\n  }\n\n  // Validate client_id\n  if (String(authCode.authorizationClientId) !== String(client_id)) {\n    return res.status(400).json({ error: 'invalid_grant', error_description: 'client_id mismatch' });\n  }\n\n  // Validate redirect_uri\n  if (authCode.url !== (redirect_uri || '')) {\n    return res.status(400).json({ error: 'invalid_grant', error_description: 'redirect_uri mismatch' });\n  }\n\n  // Validate PKCE\n  if (authCode.codeChallenge) {\n    if (!code_verifier) {\n      return res.status(400).json({ error: 'invalid_grant', error_description: 'code_verifier is required' });\n    }\n    const expectedChallenge = createHash('sha256').update(code_verifier).digest('base64url');\n    if (expectedChallenge !== authCode.codeChallenge) {\n      return res.status(400).json({ error: 'invalid_grant', error_description: 'PKCE verification failed' });\n    }\n  }\n\n  // Issue access token (refreshable for auth code flow)\n  const accessToken = await OAuth2Service.getNewAccessToken(\n    authCode.owner,\n    authCode.authorizationClientId,\n    true,\n  );\n\n  // Delete the used authorization code\n  await authCode.destroy();\n\n  const expiresIn = Math.floor((new Date(accessToken.expire).getTime() - Date.now()) / 1000);\n\n  return res.status(200).json({\n    access_token: accessToken.token,\n    token_type: 'bearer',\n    expires_in: expiresIn,\n    ...(accessToken.refreshToken ? { refresh_token: accessToken.refreshToken } : {}),\n  });\n}\n\nasync function handleClientCredentials(req: RedstoneRequest, res: RedstoneResponse) {\n  const clientId = req.body.client_id;\n  const clientSecret = req.body.client_secret;\n\n  if (!clientId || !clientSecret) {\n    return res.status(400).json({ error: 'invalid_request', error_description: 'client_id and client_secret are required' });\n  }\n\n  const authorizationClient = await AuthorizationClient.findByPk(clientId);\n  if (!authorizationClient || !authorizationClient.secret || !authorizationClient.owner) {\n    return res.status(401).json({ error: 'invalid_client' });\n  }\n\n  const verified = await bcrypt.compare(clientSecret, authorizationClient.secret);\n  if (!verified) {\n    return res.status(401).json({ error: 'invalid_client' });\n  }\n\n  const accessToken = await OAuth2Service.getNewAccessToken(\n    authorizationClient.owner,\n    authorizationClient.id,\n    false,\n  );\n\n  const expiresIn = Math.floor((new Date(accessToken.expire).getTime() - Date.now()) / 1000);\n\n  return res.status(200).json({\n    access_token: accessToken.token,\n    token_type: 'bearer',\n    expires_in: expiresIn,\n  });\n}\n\nasync function handleRefreshToken(req: RedstoneRequest, res: RedstoneResponse) {\n  const { refresh_token, client_id } = req.body;\n\n  if (!refresh_token) {\n    return res.status(400).json({ error: 'invalid_request', error_description: 'refresh_token is required' });\n  }\n\n  const existingToken = await AuthorizationAccessToken.findOne({\n    where: { refreshToken: refresh_token, status: 'active' },\n  });\n\n  if (!existingToken) {\n    return res.status(400).json({ error: 'invalid_grant', error_description: 'Invalid refresh token' });\n  }\n\n  // Validate client_id if provided\n  if (client_id && String(existingToken.authorizationClientId) !== String(client_id)) {\n    return res.status(400).json({ error: 'invalid_grant', error_description: 'client_id mismatch' });\n  }\n\n  // Issue new access token\n  const accessToken = await OAuth2Service.getNewAccessToken(\n    existingToken.owner,\n    existingToken.authorizationClientId,\n    true,\n  );\n\n  const expiresIn = Math.floor((new Date(accessToken.expire).getTime() - Date.now()) / 1000);\n\n  return res.status(200).json({\n    access_token: accessToken.token,\n    token_type: 'bearer',\n    expires_in: expiresIn,\n    ...(accessToken.refreshToken ? { refresh_token: accessToken.refreshToken } : {}),\n  });\n}\n\nexport default token;\n"],"sourceRoot":"../../../../src"}