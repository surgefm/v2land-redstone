{"version":3,"sources":["../api/controllers/RoleController/updateClientPermission.ts"],"names":[],"mappings":"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","file":"updateClientPermission.js","sourcesContent":["import { AccessControlService } from '@Services';\nimport { RedstoneRequest, RedstoneResponse } from '@Types';\nimport { sequelize, Record } from '@Models';\n\nexport default async function updateClientPermission(req: RedstoneRequest, res: RedstoneResponse) {\n  if (!req.body && !req.body.clientId && !req.body.resource && !req.body.action) {\n    return res.status(400).json({\n      message: '缺少参数 clientId 或 resource 或 action',\n    });\n  }\n\n  const data = {\n    clientId: parseInt(req.body.clientId),\n    action: req.body.action,\n    // should be like event-123\n    resource: req.body.resource,\n  };\n\n  if (isNaN(data.clientId)) {\n    return res.status(400).json({\n      message: '参数 clientId 不是数字',\n    });\n  }\n  await sequelize.transaction(async transaction => {\n    const roleName = `${data.resource}-${data.action}-role`;\n    if (req.method === 'DELETE') {\n      await AccessControlService.removeUserRoles(data.clientId, roleName, (err) => {\n        if (err) {\n          return res.status(404).json({\n            message: `用户 ${data.clientId}没有 \"${data.action}\" ${data.resource} 的权限，删除失败`,\n          });\n        }\n      });\n    } else if (req.method === 'POST') {\n      await AccessControlService.addUserRoles(data.clientId, roleName, (err) => {\n        if (err) {\n          return res.status(403).json({\n            message: `用户 ${data.clientId}已经拥有 \"${data.action}\" ${data.resource} 的权限`,\n          });\n        }\n      });\n    }\n    const opWord = req.method === 'DELETE' ? 'delete' : 'update';\n    await Record.create({\n      operation: opWord,\n      model: 'acl',\n      data: { role: roleName, action: data.action, resource: data.resource },\n      client: req.session.clientId,\n      target: data.clientId,\n      action: 'updateClientPermission',\n    }, { transaction });\n    let message;\n    if (req.method === 'POST') {\n      message = `用户 ${data.clientId}现在拥有 \"${data.action}\" ${data.resource} 的权限，更新成功`;\n    } else if (req.method === 'DELETE') {\n      message = `用户 ${data.clientId}现在失去了 \"${data.action}\" ${data.resource} 的权限，删除成功`;\n    }\n    res.status(200).json({\n      message: message,\n    });\n  });\n}\n"],"sourceRoot":"../../../../src"}