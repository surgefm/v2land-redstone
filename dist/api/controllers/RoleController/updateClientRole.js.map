{"version":3,"sources":["../api/controllers/RoleController/updateClientRole.ts"],"names":[],"mappings":"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","file":"updateClientRole.js","sourcesContent":["import { AccessControlService } from '@Services';\nimport { RedstoneRequest, RedstoneResponse } from '@Types';\nimport { sequelize, Record } from '@Models';\n\nexport default async function updateClientRole(req: RedstoneRequest, res: RedstoneResponse) {\n  if (!req.body && !req.body.clientId && !req.body.roleName) {\n    return res.status(400).json({\n      message: '缺少参数 clientId 或 roleName',\n    });\n  }\n\n  const data = {\n    clientId: parseInt(req.body.clientId),\n    // should be like event-123-edit-role\n    roleName: req.body.roleName,\n  };\n\n  if (isNaN(data.clientId)) {\n    return res.status(400).json({\n      message: '参数 clientId 不是数字',\n    });\n  }\n  await sequelize.transaction(async transaction => {\n    if (req.method === 'DELETE') {\n      await AccessControlService.removeUserRoles(data.clientId, data.roleName, (err) => {\n        if (err) {\n          return res.status(404).json({\n            message: `用户 ${data.clientId} 的角色 ${data.roleName} 不存在，删除失败`,\n          });\n        }\n      });\n    } else if (req.method === 'POST') {\n      await AccessControlService.addUserRoles(data.clientId, data.roleName, (err) => {\n        if (err) {\n          return res.status(403).json({\n            message: `用户 ${data.clientId} 的角色 ${data.roleName} 已经存在`,\n          });\n        }\n      });\n    }\n    const opWord = req.method === 'DELETE' ? 'delete' : 'update';\n    await Record.create({\n      operation: opWord,\n      model: 'acl',\n      data: { role: data.roleName },\n      client: req.session.clientId,\n      target: data.clientId,\n      action: 'updateClientRole',\n    }, { transaction });\n    let message;\n    if (req.method === 'POST') {\n      message = `用户 ${data.clientId} 的角色 ${data.roleName} 更新成功`;\n    } else if (req.method === 'DELETE') {\n      message = `用户 ${data.clientId} 的角色 ${data.roleName} 删除成功`;\n    }\n    res.status(200).json({\n      message: message,\n    });\n  });\n}\n"],"sourceRoot":"../../../../src"}