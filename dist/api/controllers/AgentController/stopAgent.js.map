{"version":3,"sources":["../api/controllers/AgentController/stopAgent.ts"],"names":[],"mappings":";;;;;;;;;;;AACA,yCAAoE;AAEpE,SAAe,SAAS,CAAC,GAAoB,EAAE,GAAqB;;QAClE,MAAM,IAAI,GAAG,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC;QAClC,MAAM,OAAO,GAAG,MAAM,wBAAY,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QAEpD,IAAI,CAAC,OAAO,EAAE;YACZ,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,QAAQ,EAAE,CAAC,CAAC;SACpD;QAED,IAAI;YACF,MAAM,OAAO,GAAG,MAAM,wBAAY,CAAC,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC;YAC/D,IAAI,CAAC,OAAO,EAAE;gBACZ,OAAO,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;aAC1D;YAED,sEAAsE;YACtE,MAAM,wBAAY,CAAC,SAAS,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;YAElD,wDAAwD;YACxD,MAAM,SAAS,GAAG,MAAM,wBAAY,CAAC,oBAAoB,EAAE,CAAC;YAC5D,MAAM,uBAAW,CAAC,WAAW,CAC3B,UAAU,EACV,SAAS,CAAC,EAAE,EACZ,0BAA0B,EAC1B,OAAO,CACR,CAAC;YAEF,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC;gBACnB,OAAO,EAAE,aAAa;gBACtB,OAAO;aACR,CAAC,CAAC;SACJ;QAAC,OAAO,GAAG,EAAE;YACZ,CAAC,GAAG,CAAC,GAAG,IAAI,OAAO,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAChC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,cAAc,EAAE,CAAC,CAAC;SACnD;IACH,CAAC;CAAA;AAED,kBAAe,SAAS,CAAC","file":"stopAgent.js","sourcesContent":["import { RedstoneRequest, RedstoneResponse } from '@Types';\nimport { EventService, AgentService, ChatService } from '@Services';\n\nasync function stopAgent(req: RedstoneRequest, res: RedstoneResponse) {\n  const name = req.params.eventName;\n  const eventId = await EventService.getEventId(name);\n\n  if (!eventId) {\n    return res.status(404).json({ message: '未找到该事件' });\n  }\n\n  try {\n    const running = await AgentService.AgentLock.isLocked(eventId);\n    if (!running) {\n      return res.status(404).json({ message: '当前没有运行中的 Bot' });\n    }\n\n    // Set stop flag — the agentic loop will check this between iterations\n    await AgentService.AgentLock.requestStop(eventId);\n\n    // Send a chat message notifying that stop was requested\n    const botClient = await AgentService.getOrCreateBotClient();\n    await ChatService.sendMessage(\n      'newsroom',\n      botClient.id,\n      'Bot 已收到停止请求，将在当前操作完成后停止。',\n      eventId,\n    );\n\n    res.status(200).json({\n      message: 'Bot 停止请求已发送',\n      eventId,\n    });\n  } catch (err) {\n    (req.log || console).error(err);\n    res.status(500).json({ message: '停止 Bot 时发生错误' });\n  }\n}\n\nexport default stopAgent;\n"],"sourceRoot":"../../../../src"}