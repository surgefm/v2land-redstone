{"version":3,"sources":["../api/mcp/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import type { Express, Request, Response } from 'express';\nimport { randomUUID } from 'crypto';\nimport { SYSTEM_PROMPT } from './mcpInstruction';\nimport { executeTool, ToolContext } from '@Services/AgentService/tools';\nimport { McpServer, StreamableHTTPServerTransport } from './sdk';\nimport * as schemas from './toolSchemas';\n\ninterface ToolArgs {\n  eventId?: number;\n  [key: string]: any;\n}\n\nexport function createMcpServer(botClientId: number, clientId: number) {\n  let sessionEventId: number | null = null;\n  const runId = randomUUID();\n\n  function resolveEventId(argsEventId?: number): number {\n    const eventId = argsEventId ?? sessionEventId;\n    if (!eventId) {\n      throw new Error(\n        'No eventId provided and no session default set. Call set_event first or pass eventId.',\n      );\n    }\n    return eventId;\n  }\n\n  function makeCtx(eventId: number): ToolContext {\n    return { eventId, clientId, botClientId, runId, source: 'mcp' };\n  }\n\n  function textResult(text: string) {\n    return { content: [{ type: 'text' as const, text }] };\n  }\n\n  const server = new McpServer(\n    { name: 'surge-newsroom', version: '1.0.0' },\n    { instructions: SYSTEM_PROMPT },\n  );\n\n  server.registerTool(\n    'set_event',\n    {\n      description: 'Set the active event/timeline ID for this session. Once set, other tools will use it by default.',\n      inputSchema: schemas.setEventSchema,\n    },\n    async (args: ToolArgs) => {\n      sessionEventId = args.eventId!;\n      return textResult(JSON.stringify({ success: true, eventId: args.eventId }));\n    },\n  );\n\n  server.registerTool(\n    'get_current_stacks',\n    {\n      description: 'Get the current state of the timeline, including all stacks (progress entries), their news items, and off-shelf news. Call this to understand what already exists before making changes.',\n      inputSchema: schemas.getCurrentStacksSchema,\n    },\n    async (args: ToolArgs) => {\n      const eventId = resolveEventId(args.eventId);\n      const result = await executeTool('get_current_stacks', {}, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'create_stack',\n    {\n      description: 'Create a new progress entry (stack) in the timeline. Each stack represents a distinct development in the event.',\n      inputSchema: schemas.createStackSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('create_stack', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'add_news_to_event',\n    {\n      description: 'Add a news article to the event. Optionally assign it to a specific stack. The news will appear in the newsroom.',\n      inputSchema: schemas.addNewsToEventSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('add_news_to_event', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'add_news_to_stack',\n    {\n      description: 'Move an existing news item into a specific stack.',\n      inputSchema: schemas.addNewsToStackSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('add_news_to_stack', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'update_stack',\n    {\n      description: \"Update an existing stack's title, description, or time.\",\n      inputSchema: schemas.updateStackSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('update_stack', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'reorder_stacks',\n    {\n      description: 'Rearrange the display order of stacks in the timeline. Provide stack IDs in the desired order, from most recent (first) to oldest (last).',\n      inputSchema: schemas.reorderStacksSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('reorder_stacks', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'send_chat_message',\n    {\n      description: 'Send a message to the newsroom chatroom. Use this to report progress, share findings, or communicate with editors.',\n      inputSchema: schemas.sendChatMessageSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('send_chat_message', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'create_event',\n    {\n      description: 'Create a new event/timeline. Returns the new event ID. Use set_event afterwards to start working on it.',\n      inputSchema: schemas.createEventSchema,\n    },\n    async (args: ToolArgs) => {\n      const result = await executeTool('create_event', args, makeCtx(0));\n      const parsed = JSON.parse(result);\n      if (parsed.eventId) {\n        sessionEventId = parsed.eventId;\n      }\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'get_newsroom_link',\n    {\n      description: 'Get the newsroom URL for the current event so the user can review the timeline in their browser.',\n      inputSchema: schemas.getNewsroomLinkSchema,\n    },\n    async (args: ToolArgs) => {\n      const eventId = resolveEventId(args.eventId);\n      const result = await executeTool('get_newsroom_link', {}, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'update_event',\n    {\n      description: \"Update the current event's name or description.\",\n      inputSchema: schemas.updateEventSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('update_event', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'remove_news_from_stack',\n    {\n      description: 'Move a news item out of a stack and back to off-shelf (unassign without deleting).',\n      inputSchema: schemas.removeNewsFromStackSchema,\n    },\n    async (args: ToolArgs) => {\n      const { eventId: argsEventId, ...toolArgs } = args;\n      const eventId = resolveEventId(argsEventId);\n      const result = await executeTool('remove_news_from_stack', toolArgs, makeCtx(eventId));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'search_events',\n    {\n      description: 'Search for events/timelines in the database by keyword. Returns matching events with their IDs. Use this to find an event ID before calling set_event.',\n      inputSchema: schemas.searchEventsSchema,\n    },\n    async (args: ToolArgs) => {\n      const result = await executeTool('search_events', args, makeCtx(0));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'get_editorial_guidelines',\n    {\n      description: 'Retrieve the editorial guidelines and workflow instructions for this newsroom assistant.',\n      inputSchema: schemas.getEditorialGuidelinesSchema,\n    },\n    async () => {\n      const result = await executeTool('get_editorial_guidelines', {}, makeCtx(0));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'get_followed_editable_events',\n    {\n      description: 'Get events the current user is following (subscribed to) that they also have edit permission for. Returns event IDs, names, descriptions, and statuses.',\n      inputSchema: schemas.getFollowedEditableEventsSchema,\n    },\n    async () => {\n      const result = await executeTool('get_followed_editable_events', {}, makeCtx(0));\n      return textResult(result);\n    },\n  );\n\n  server.registerTool(\n    'get_owned_editable_events',\n    {\n      description: 'Get events the current user owns. Owners always have edit permission. Returns event IDs, names, descriptions, and statuses.',\n      inputSchema: schemas.getOwnedEditableEventsSchema,\n    },\n    async () => {\n      const result = await executeTool('get_owned_editable_events', {}, makeCtx(0));\n      return textResult(result);\n    },\n  );\n\n  return server;\n}\n\n/**\n * Mount the MCP server on an Express app at /mcp using Streamable HTTP transport.\n * Each MCP session gets its own McpServer instance with independent state.\n * Requires Bearer token authentication — the existing bearerAuthentication middleware\n * sets req.session.clientId from a valid AuthorizationAccessToken.\n */\nexport function mountMcp(app: Express, botClientId: number) {\n  const transports = new Map<string, { transport: any; clientId: number }>();\n\n  app.all('/mcp', async (req: Request, res: Response) => {\n    // Authentication gate — return RFC 9728 resource metadata hint on 401\n    const clientId = (req as any).session?.clientId as number | undefined;\n    if (!clientId) {\n      const serverUrl = process.env.API_URL || 'https://api.langchao.org';\n      return res.status(401)\n        .set('WWW-Authenticate', `Bearer resource_metadata=\"${serverUrl}/.well-known/oauth-protected-resource\"`)\n        .json({ error: 'Authentication required' });\n    }\n\n    const sessionId = req.headers['mcp-session-id'] as string | undefined;\n\n    if (sessionId && transports.has(sessionId)) {\n      const entry = transports.get(sessionId)!;\n      if (entry.clientId !== clientId) {\n        return res.status(403).json({ error: 'Session does not belong to this user' });\n      }\n      await entry.transport.handleRequest(req, res, req.body);\n      return;\n    }\n\n    if (sessionId && !transports.has(sessionId)) {\n      res.status(404).json({ error: 'Session not found' });\n      return;\n    }\n\n    // New session\n    const transport = new StreamableHTTPServerTransport({\n      sessionIdGenerator: () => randomUUID(),\n    });\n    const server = createMcpServer(botClientId, clientId);\n\n    transport.onclose = () => {\n      if (transport.sessionId) {\n        transports.delete(transport.sessionId);\n      }\n    };\n\n    await server.connect(transport);\n    await transport.handleRequest(req, res, req.body);\n\n    if (transport.sessionId) {\n      transports.set(transport.sessionId, { transport, clientId });\n    }\n  });\n\n  console.log('MCP server mounted at /mcp (authentication required)');\n}\n"],"sourceRoot":"../../../src"}