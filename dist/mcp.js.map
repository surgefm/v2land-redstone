{"version":3,"sources":["../mcp.ts"],"names":[],"mappings":";AAAA,uDAAuD;AACvD,qEAAqE;AACrE,4EAA4E;AAC5E,EAAE;AACF,qEAAqE;;;;;;;;;;;;;;AAErE,uCAAqC;AACrC,iCAA+B;AAC/B,oDAA4B;AAC5B,gDAAwB;AACxB,gBAAM,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,cAAI,CAAC,OAAO,CAAC,SAAS,EAAE,IAAI,EAAE,MAAM,CAAC,EAAE,CAAC,CAAC;AAE/D,iFAAiF;AACjF,MAAM,OAAO,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AAC5C,OAAO,CAAC,GAAG,GAAG,CAAC,GAAG,IAAW,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,CAAC;AAC5D,OAAO,CAAC,IAAI,GAAG,CAAC,GAAG,IAAW,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,CAAC;AAE7D,oEAA4C;AAC5C,2FAAgE;AAChE,yDAA8D;AAC9D,mCAA4C;AAC5C,uCAAqD;AACrD,qCAAmD;AAEnD,SAAe,IAAI;;QACjB,MAAM,IAAA,uBAAa,GAAE,CAAC;QACtB,MAAM,IAAA,oBAAO,GAAE,CAAC;QAChB,MAAM,SAAS,GAAG,MAAM,IAAA,mCAAoB,GAAE,CAAC;QAE/C,4CAA4C;QAC5C,MAAM,QAAQ,GAAG,OAAO,CAAC,GAAG,CAAC,gBAAgB,CAAC;QAC9C,IAAI,CAAC,QAAQ,EAAE;YACb,OAAO,CAAC,KAAK,CAAC,mDAAmD,CAAC,CAAC;YACnE,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;SACjB;QAED,MAAM,WAAW,GAAG,MAAM,kCAAwB,CAAC,OAAO,CAAC;YACzD,KAAK,EAAE,EAAE,KAAK,EAAE,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE;SAC7C,CAAC,CAAC;QACH,IAAI,CAAC,WAAW,EAAE;YAChB,OAAO,CAAC,KAAK,CAAC,qCAAqC,CAAC,CAAC;YACrD,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;SACjB;QACD,IAAI,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,GAAG,IAAI,IAAI,EAAE,EAAE;YAC7C,OAAO,CAAC,KAAK,CAAC,8BAA8B,CAAC,CAAC;YAC9C,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;SACjB;QAED,MAAM,QAAQ,GAAG,WAAW,CAAC,KAAK,CAAC;QACnC,OAAO,CAAC,GAAG,CAAC,2BAA2B,QAAQ,EAAE,CAAC,CAAC;QAEnD,MAAM,MAAM,GAAG,IAAA,qBAAe,EAAC,SAAS,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAC;QACvD,MAAM,SAAS,GAAG,IAAI,0BAAoB,EAAE,CAAC;QAC7C,MAAM,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;IAClC,CAAC;CAAA;AAED,IAAI,EAAE,CAAC,KAAK,CAAC,CAAC,GAAG,EAAE,EAAE;IACnB,OAAO,CAAC,KAAK,CAAC,6BAA6B,EAAE,GAAG,CAAC,CAAC;IAClD,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC,CAAC","file":"mcp.js","sourcesContent":["// Standalone MCP server entry point (stdio transport).\n// Use this for Claude Desktop or other subprocess-based MCP clients.\n// The MCP server also launches by default with the Express service at /mcp.\n//\n// Requires MCP_ACCESS_TOKEN environment variable for authentication.\n\nimport 'source-map-support/register';\nimport 'module-alias/register';\nimport dotenv from 'dotenv';\nimport path from 'path';\ndotenv.config({ path: path.resolve(__dirname, '..', '.env') });\n\n// Redirect console.log/info to stderr so they don't corrupt MCP stdio on stdout.\nconst _stderr = console.error.bind(console);\nconsole.log = (...args: any[]) => _stderr('[MCP]', ...args);\nconsole.info = (...args: any[]) => _stderr('[MCP]', ...args);\n\nimport loadSequelize from './loadSequelize';\nimport loadAcl from '@Services/AccessControlService/initialize';\nimport { getOrCreateBotClient } from '@Services/AgentService';\nimport { createMcpServer } from './api/mcp';\nimport { StdioServerTransport } from './api/mcp/sdk';\nimport { AuthorizationAccessToken } from '@Models';\n\nasync function main() {\n  await loadSequelize();\n  await loadAcl();\n  const botClient = await getOrCreateBotClient();\n\n  // Authenticate via MCP_ACCESS_TOKEN env var\n  const tokenStr = process.env.MCP_ACCESS_TOKEN;\n  if (!tokenStr) {\n    console.error('MCP_ACCESS_TOKEN environment variable is required');\n    process.exit(1);\n  }\n\n  const accessToken = await AuthorizationAccessToken.findOne({\n    where: { token: tokenStr, status: 'active' },\n  });\n  if (!accessToken) {\n    console.error('Invalid or revoked MCP_ACCESS_TOKEN');\n    process.exit(1);\n  }\n  if (new Date(accessToken.expire) < new Date()) {\n    console.error('MCP_ACCESS_TOKEN has expired');\n    process.exit(1);\n  }\n\n  const clientId = accessToken.owner;\n  console.log(`Authenticated as client ${clientId}`);\n\n  const server = createMcpServer(botClient.id, clientId);\n  const transport = new StdioServerTransport();\n  await server.connect(transport);\n}\n\nmain().catch((err) => {\n  console.error('Failed to start MCP server:', err);\n  process.exit(1);\n});\n"],"sourceRoot":"../src"}