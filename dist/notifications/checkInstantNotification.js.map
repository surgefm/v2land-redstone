{"version":3,"sources":["../notifications/checkInstantNotification.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;GAEG;AACH,qCAA8C;AAC9C,yCAA+B;AAC/B,sDAA8B;AAC9B,gDAAwB;AACxB,MAAM,MAAM,GAAG,IAAA,cAAI,GAAE,CAAC;AACtB,MAAM,aAAa,GAAG,IAAI,CAAC;AAE3B,SAAe,wBAAwB;;QACrC,IAAI;YACF,MAAM,YAAY,GAAG,MAAM,sBAAY,CAAC,OAAO,CAAC;gBAC9C,KAAK,EAAE,CAAC,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;gBACzB,KAAK,EAAE;oBACL,MAAM,EAAE,SAAS;oBACjB,IAAI,EAAE,EAAE,CAAC,cAAE,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE;iBAC/B;gBACD,OAAO,EAAE,CAAC,eAAK,CAAC;aACjB,CAAC,CAAC;YAEH,IAAI,CAAC,YAAY,EAAE;gBACjB,UAAU,CAAC,wBAAwB,EAAE,aAAa,CAAC,CAAC;aACrD;iBAAM;gBACL,MAAM,IAAA,gBAAM,EAAC,YAAY,CAAC,CAAC;gBAC3B,wBAAwB,EAAE,CAAC;aAC5B;SACF;QAAC,OAAO,GAAG,EAAE;YACZ,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAClB,UAAU,CAAC,wBAAwB,EAAE,aAAa,CAAC,CAAC;SACrD;IACH,CAAC;CAAA;AAED,MAAM,CAAC,OAAO,GAAG,wBAAwB,CAAC","file":"checkInstantNotification.js","sourcesContent":["/**\n * 检查有没有需要发出的即时推送\n */\nimport { Notification, Event } from '@Models';\nimport { Op } from 'sequelize';\nimport notify from './notify';\nimport pino from 'pino';\nconst logger = pino();\nconst checkInterval = 1000;\n\nasync function checkInstantNotification() {\n  try {\n    const notification = await Notification.findOne({\n      order: [['time', 'DESC']],\n      where: {\n        status: 'pending',\n        time: { [Op.lte]: Date.now() },\n      },\n      include: [Event],\n    });\n\n    if (!notification) {\n      setTimeout(checkInstantNotification, checkInterval);\n    } else {\n      await notify(notification);\n      checkInstantNotification();\n    }\n  } catch (err) {\n    logger.error(err);\n    setTimeout(checkInstantNotification, checkInterval);\n  }\n}\n\nmodule.exports = checkInstantNotification;\n"],"sourceRoot":"../../src"}