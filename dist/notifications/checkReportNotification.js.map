{"version":3,"sources":["../notifications/checkReportNotification.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;GAEG;AACH,qCAA4C;AAC5C,yCAA+B;AAC/B,8DAAsC;AACtC,gDAAwB;AACxB,MAAM,MAAM,GAAG,IAAA,cAAI,GAAE,CAAC;AACtB,MAAM,aAAa,GAAG,IAAI,CAAC;AAE3B,SAAe,uBAAuB;;QACpC,IAAI;YACF,MAAM,MAAM,GAAG,MAAM,gBAAM,CAAC,OAAO,CAAC;gBAClC,KAAK,EAAE,CAAC,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;gBACxB,KAAK,EAAE;oBACL,MAAM,EAAE,SAAS;oBACjB,IAAI,EAAE,EAAE,CAAC,cAAE,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,GAAG,EAAE,EAAE;iBAC/B;aACF,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,EAAE;gBACX,UAAU,CAAC,uBAAuB,EAAE,aAAa,CAAC,CAAC;aACpD;iBAAM;gBACL,MAAM,mBAAS,CAAC,WAAW,CAAC,CAAM,WAAW,EAAC,EAAE;oBAC9C,MAAM,MAAM,CAAC,MAAM,CACjB,EAAE,MAAM,EAAE,SAAS,EAAE,EACrB,EAAE,WAAW,EAAE,CAAC,CAAC;oBACnB,MAAM,IAAA,oBAAU,EAAC,MAAM,EAAE,EAAE,WAAW,EAAE,CAAC,CAAC;gBAC5C,CAAC,CAAA,CAAC,CAAC;gBACH,uBAAuB,EAAE,CAAC;aAC3B;SACF;QAAC,OAAO,GAAG,EAAE;YACZ,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAClB,UAAU,CAAC,uBAAuB,EAAE,aAAa,CAAC,CAAC;SACpD;IACH,CAAC;CAAA;AAED,kBAAe,uBAAuB,CAAC","file":"checkReportNotification.js","sourcesContent":["/**\n * 检查有没有需要发出的汇总推送\n */\nimport { Report, sequelize } from '@Models';\nimport { Op } from 'sequelize';\nimport sendReport from './sendReport';\nimport pino from 'pino';\nconst logger = pino();\nconst checkInterval = 2000;\n\nasync function checkReportNotification() {\n  try {\n    const report = await Report.findOne({\n      order: [['time', 'ASC']],\n      where: {\n        status: 'pending',\n        time: { [Op.lte]: Date.now() },\n      },\n    });\n\n    if (!report) {\n      setTimeout(checkReportNotification, checkInterval);\n    } else {\n      await sequelize.transaction(async transaction => {\n        await report.update(\n          { status: 'ongoing' },\n          { transaction });\n        await sendReport(report, { transaction });\n      });\n      checkReportNotification();\n    }\n  } catch (err) {\n    logger.error(err);\n    setTimeout(checkReportNotification, checkInterval);\n  }\n}\n\nexport default checkReportNotification;\n"],"sourceRoot":"../../src"}