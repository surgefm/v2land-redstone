{"version":3,"sources":["../notifications/notifyByWeiboAt.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;GAEG;AACH,qCAAsD;AACtD,yCAAsD;AACtD,uCAAmC;AACnC,gDAAwB;AACxB,MAAM,MAAM,GAAG,IAAA,cAAI,GAAE,CAAC;AACtB,4FAAoE;AAEpE,SAAe,eAAe,CAAC,EAAE,OAAO,EAAE,YAAY,EAAE,QAAQ,EAI/D;;QACC,IAAI,CAAC,kBAAO,CAAC,eAAe,CAAC,KAAK,EAAE;YAClC,OAAO,MAAM,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC;SAC7C;QAED,IAAI,SAAS,GAAG,kBAAO,CAAC,eAAe,CAAC,KAAK,CAAC;QAC9C,SAAS,GAAG,OAAO,CAAC,SAAS,CAAC,KAAK,QAAQ;YACzC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC;YACzD,CAAC,CAAC,SAAS,CAAC;QAEd,MAAM,IAAI,GAAG,MAAM,cAAI,CAAC,OAAO,CAAC;YAC9B,KAAK,EAAE;gBACL,IAAI,EAAE,OAAO;gBACb,SAAS;aACV;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,EAAE;YACT,OAAO,MAAM,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,WAAW,SAAS,MAAM,CAAC,CAAC,CAAC;SAC5D;QAED,IAAI,CAAC,OAAO,CAAC,IAAI;YAAE,OAAO,IAAA,mCAAyB,EAAC,YAAY,CAAC,CAAC;QAElE,IAAI,OAAO,GAAG,GAAG,GAAG,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,GAAG,GAAG,CAAC;QAC3D,OAAO,IAAI,uBAAW,CAAC,aAAa,CAAC,QAAQ,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;QAC3D,OAAO,IAAI,GAAG,GAAG,uBAAW,CAAC,0BAA0B,CAAC,CAAC,CAAC,CAAC;QAC3D,OAAO,IAAI,GAAG,GAAG,QAAQ,CAAC,GAAG,CAAC;QAE9B,OAAO,wBAAY,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;IAC1C,CAAC;CAAA;AAED,kBAAe,eAAe,CAAC","file":"notifyByWeiboAt.js","sourcesContent":["/**\n * 使用浪潮的绑定账号发布微博并 @ 用户\n */\nimport { Contact, Subscription, Auth } from '@Models';\nimport { UtilService, WeiboService } from '@Services';\nimport { globals } from '@Configs';\nimport pino from 'pino';\nconst logger = pino();\nimport disableSubscriptionMethod from './disableSubscriptionMethod';\n\nasync function notifyByWeiboAt({ contact, subscription, template }: {\n  contact: Contact;\n  subscription: Subscription;\n  template: any;\n}) {\n  if (!globals.officialAccount.weibo) {\n    return logger.error(new Error('未配置官方微博账号'));\n  }\n\n  let profileId = globals.officialAccount.weibo;\n  profileId = typeof (profileId) === 'object'\n    ? profileId[Math.floor(Math.random() * profileId.length)]\n    : profileId;\n\n  const auth = await Auth.findOne({\n    where: {\n      site: 'weibo',\n      profileId,\n    },\n  });\n\n  if (!auth) {\n    return logger.error(new Error(`未找到浪潮微博 ${profileId} 的绑定`));\n  }\n\n  if (!contact.auth) return disableSubscriptionMethod(subscription);\n\n  let message = '@' + contact.auth.profile.screen_name + ' ';\n  message += UtilService.shortenString(template.message, 96);\n  message += ' ' + UtilService.generateRandomV2landString(4);\n  message += ' ' + template.url;\n\n  return WeiboService.post(auth, message);\n}\n\nexport default notifyByWeiboAt;\n"],"sourceRoot":"../../src"}