{"version":3,"sources":["../notifications/notifyByTwitterAt.ts"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;GAEG;AACH,qCAAsD;AACtD,yCAAwD;AACxD,uCAAmC;AACnC,4FAAoE;AACpE,gDAAwB;AACxB,MAAM,MAAM,GAAG,IAAA,cAAI,GAAE,CAAC;AAEtB,SAAe,iBAAiB,CAAC,EAAE,OAAO,EAAE,YAAY,EAAE,QAAQ,EAIjE;;QACC,IAAI,CAAC,kBAAO,CAAC,eAAe,CAAC,OAAO,EAAE;YACpC,OAAO,MAAM,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC,CAAC;SACpD;QAED,IAAI,SAAS,GAAG,kBAAO,CAAC,eAAe,CAAC,OAAO,CAAC;QAChD,SAAS,GAAG,OAAM,CAAC,SAAS,CAAC,KAAK,QAAQ;YACxC,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,EAAE,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC;YACzD,CAAC,CAAC,SAAS,CAAC;QAEd,MAAM,IAAI,GAAG,MAAM,cAAI,CAAC,OAAO,CAAC;YAC9B,KAAK,EAAE;gBACL,IAAI,EAAE,SAAS;gBACf,SAAS;aACV;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,EAAE;YACT,OAAO,MAAM,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,iBAAiB,SAAS,MAAM,CAAC,CAAC,CAAC;SAClE;QAED,IAAI,CAAC,OAAO,CAAC,IAAI;YAAE,OAAO,IAAA,mCAAyB,EAAC,YAAY,CAAC,CAAC;QAElE,IAAI,OAAO,GAAG,GAAG,GAAG,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,GAAG,GAAG,CAAC;QAC3D,OAAO,IAAI,uBAAW,CAAC,aAAa,CAAC,QAAQ,CAAC,OAAO,EAAE,GAAG,CAAC,CAAC;QAC5D,OAAO,IAAI,GAAG,GAAG,QAAQ,CAAC,GAAG,GAAG,MAAM,CAAC;QACvC,OAAO,0BAAc,CAAC,KAAK,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;IAC7C,CAAC;CAAA;AAED,kBAAe,iBAAiB,CAAC","file":"notifyByTwitterAt.js","sourcesContent":["/**\n * 使用浪潮的绑定账号发布推文并 @ 用户\n */\nimport { Contact, Subscription, Auth } from '@Models';\nimport { UtilService, TwitterService } from '@Services';\nimport { globals } from '@Configs';\nimport disableSubscriptionMethod from './disableSubscriptionMethod';\nimport pino from 'pino';\nconst logger = pino();\n\nasync function notifyByTwitterAt({ contact, subscription, template }: {\n  contact: Contact;\n  subscription: Subscription;\n  template: any;\n}) {\n  if (!globals.officialAccount.twitter) {\n    return logger.error(new Error('未配置官方 Twitter 账号'));\n  }\n\n  let profileId = globals.officialAccount.twitter;\n  profileId = typeof(profileId) === 'object'\n    ? profileId[Math.floor(Math.random() * profileId.length)]\n    : profileId;\n\n  const auth = await Auth.findOne({\n    where: {\n      site: 'twitter',\n      profileId,\n    },\n  });\n\n  if (!auth) {\n    return logger.error(new Error(`未找到浪潮 Twitter ${profileId} 的绑定`));\n  }\n\n  if (!contact.auth) return disableSubscriptionMethod(subscription);\n\n  let message = '@' + contact.auth.profile.screen_name + ' ';\n  message += UtilService.shortenString(template.message, 100);\n  message += ' ' + template.url + ' #浪潮';\n  return TwitterService.tweet(auth, message);\n}\n\nexport default notifyByTwitterAt;\n"],"sourceRoot":"../../src"}