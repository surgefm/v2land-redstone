{"version":3,"sources":["../notifications/notifyByEmailDailyReport.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA;;GAEG;AACH,qCAA4F;AAC5F,yCAAwC;AAExC,SAAe,wBAAwB,CAAC,EAAE,YAAY,EAAE,YAAY,EAGnE;;QACC,MAAM,IAAI,GAAG,MAAM,uBAAW,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,CAAC;QAEtD,MAAM,mBAAS,CAAC,WAAW,CAAC,CAAM,WAAW,EAAC,EAAE;YAC9C,MAAM,UAAU,GAAG;gBACjB,IAAI,EAAE,IAAI,CAAC,OAAO,EAAE;gBACpB,MAAM,EAAE,SAAS;gBACjB,IAAI,EAAE,OAAO;gBACb,KAAK,EAAE,YAAY,CAAC,UAAU;aAC/B,CAAC;YACF,MAAM,MAAM,GAAG,CAAC,MAAM,gBAAM,CAAC,YAAY,CAAC;gBACxC,KAAK,EAAE,UAAU;gBACjB,QAAQ,EAAE,UAAU;gBACpB,WAAW;aACZ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAEP,MAAM,sBAAsB,GAAG;gBAC7B,MAAM,EAAE,SAAS;gBACjB,QAAQ,EAAE,MAAM,CAAC,EAAE;gBACnB,cAAc,EAAE,YAAY,CAAC,EAAE;aAChC,CAAC;YACF,MAAM,4BAAkB,CAAC,YAAY,CAAC;gBACpC,KAAK,EAAE,sBAAsB;gBAC7B,QAAQ,EAAE,sBAAsB;gBAChC,WAAW;aACZ,CAAC,CAAC;QACL,CAAC,CAAA,CAAC,CAAC;IACL,CAAC;CAAA;AAED,kBAAe,wBAAwB,CAAC","file":"notifyByEmailDailyReport.js","sourcesContent":["/**\n * 将通知添加到每日邮件简讯中\n */\nimport { Notification, Subscription, Report, ReportNotification, sequelize } from '@Models';\nimport { ModeService } from '@Services';\n\nasync function notifyByEmailDailyReport({ subscription, notification }: {\n  notification: Notification;\n  subscription: Subscription;\n}) {\n  const time = await ModeService.getMode('daily').new();\n\n  await sequelize.transaction(async transaction => {\n    const reportData = {\n      time: time.getTime(),\n      status: 'pending',\n      type: 'daily',\n      owner: subscription.subscriber,\n    };\n    const report = (await Report.findOrCreate({\n      where: reportData,\n      defaults: reportData,\n      transaction,\n    }))[0];\n\n    const reportNotificationData = {\n      status: 'pending',\n      reportId: report.id,\n      notificationId: notification.id,\n    };\n    await ReportNotification.findOrCreate({\n      where: reportNotificationData,\n      defaults: reportNotificationData,\n      transaction,\n    });\n  });\n}\n\nexport default notifyByEmailDailyReport;\n"],"sourceRoot":"../../src"}